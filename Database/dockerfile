# Use the official PostgreSQL image as base
FROM postgres:15-alpine

# Set environment variables for database configuration
ENV POSTGRES_USER=${DB_USER:-postgres}
ENV POSTGRES_PASSWORD=${DB_PASSWORD:-postgres}
ENV POSTGRES_DB=${DB_NAME:-myapp_db}

# Create and set permissions for data directory
RUN mkdir -p /var/lib/postgresql/data && \
    chown -R postgres:postgres /var/lib/postgresql/data && \
    chmod 700 /var/lib/postgresql/data

# Set volume for persistent data
VOLUME /var/lib/postgresql/data

# Expose PostgreSQL default port
EXPOSE 5432

# Set health check
HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
    CMD pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} || exit 1